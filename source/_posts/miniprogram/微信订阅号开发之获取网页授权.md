---
title: 微信订阅号开发之获取网页授权
date: 2018-09-17 19:02:20
categories: 小程序
---

题记：项目（Vue）是h5页面，主要用于公众号里面的活动，目的是增加公众号关注人数，达到推广的目的，其中涉及到获取用户的昵称、头像、unionid等基本信息。
由于微信公众号改版成订阅号之后，并没有获取用户信息的接口，服务号才有，详情可查看[官方文档](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421140842)。
所以目前想到的思路是借用和订阅号关联的服务号获取 code，然后利用获取到的code 发送给后端再请求用户信息。

首先，route.js 里面配置 needUnionId，通过 checkUnionId HOC 加工页面使其先获取 unionid，然后再通过 unionid 请求数据：
```js
import Vue from 'vue';
import Router from 'vue-router';

import {Util} from './utils';
import store from './store/store';
import http from './store/module/http';
import {checkUnionId} from './hoc';

Vue.use(Router);

const dynamicImport = (path) => async (resolve) => {
  const module = await import(`./pages/${path}`);
  resolve(module);
};

/**
 * 设置项：
 *
 * meta:
 *    title:                页面标题
 *    checkUnionId:         如果需要一进入页面就发请求并携带参数 unionid，则接入 checkUnionId
 *
 * 注意：以下的 component 为 dynamicImport 类型的，dynamicImport 的参数都有 ../pages/ 前缀，
 */
const routerList = [
  {
    path: '/wx-login',
    name: 'WXLogin',
    meta: {
      needUnionId: true
    },
    component: dynamicImport('login/wx-login')
  },
  {
    path: '/login',
    name: 'login',
    component: dynamicImport('login/login')
  },
  {
    path: '*',
    name: 'not-found',
    component: dynamicImport('exception/not-found'),
    meta: {}
  }
];

function machiningRouter(arr) {
  arr.forEach(v => {
    const needUnionId = (v.meta || {}).needUnionId === true;
    if (v.component && needUnionId) {
      v.component = checkUnionId(v.component);
    }
    if (!needUnionId && v.children) {
      machiningRouter(v.children);
    }
  });
}

machiningRouter(routerList);

const router = new Router({
  // mode: 'history',
  // base: '/',
  routes: routerList
});

router.beforeEach((to, from, next) => {
  const metaData = to.meta || {};
  !metaData.hidden && http.actions.setLoading(store, {status: true});
  metaData.title && Util.setDocumentTitle(metaData.title);
  next();
});
router.afterEach(route => {
  const metaData = route.meta || {};
  !metaData.hidden && http.actions.setLoading(store, {status: false});
});

export default router;

```

先看 wx-login.vue 的使用方式：
```js
import {Url, Util} from '@/utils';
import {WeChat, closeWindow} from '@/utils/wechat';

export default {
    name: 'WXLogin',
    data() {
        return {
        };
    },
    created()  {
        // 不需要
        // this.requestData();
    },
    methods: {
        // 适用于一进入页面就请求数据，checkUnionId 会自动调用，不需要在 created 里面手动调用
        async requestData() {
        },
        // 适用于点击按钮才请求数据，此时 checkUnionId 已经获取到了 unionid
        async handleLogin() {
        const param = {
          unionid: this.$parent.unionId,
        };
        await this.$http.post(Url.PMS_QR_CODE_LOGIN, param);
        this.$toast('扫码登录成功');
        this.status = 'success';
        },
    }
};
```

其中，checkUnionId.js 为：
```js
import {mapActions, mapGetters} from 'vuex';
import {getUnionId, WeChat} from '@/utils/wechat';

/**
 * 校验 openId 是否为 null
 */
export default (component) => ({
  computed: {
    ...mapGetters(['unionId'])
  },
  props: component.props,
  render(h) {
    return h(component, {
      on: this.$listeners,
      attrs: this.$attrs,
      props: this.$props
    });
  },
  mounted() {
    this.requestUnionId();
  },
  methods: {
    ...mapActions(['setLoading']),
    async requestUnionId() {
      try {
        if (this.unionId) {
          console.log('local unionId:', this.unionId);
          this.afterRequestUnionId();
        } else {
          this.$toast('获取信息中···');
          await getUnionId();
          await new WeChat().init();
          this.afterRequestUnionId();
        }
      } catch (e) {
        console.error('check-unionid requestUnionId:', e);
      }
    },
    afterRequestUnionId() {
      // fixme: mounted 先于子组件的 mounted 执行，所以不在 setTimeout 里执行的话，this.$children 获取不到，因为页面是按需加载，不是全量加载
      setTimeout(() => {
        this.$children.forEach(v => {
          if (!v.requestData || Object.prototype.toString.call(v) !== '[object Function]') {
            console.warn('用 checkUnionId 装饰的页面中，如果需要一进入页面就立即发送带 union_id 的请求，那么 methods 中必须有 requestData function 用于获取初始数据，否则，请忽略此条。');
          } else {
            v.requestData();
          }
        });
      }, 200);
    }
  }
});
```

wechat.js 为：
```js
import Vue from 'vue';
import store from '@/store/store';
import user from '@/store/module/user';
import http from '@/store/module/http';
import Util from './util';
import axiosInstance from './axios-instance';
import Url from './url';

const APP_ID = 'APP_ID';

const DEFAULT_DATA = {
  appId: APP_ID,
  apiList: [
    'checkJsApi',
    'closeWindow',
    'hideAllNonBaseMenuItem'
  ],
  errorType: [
    {code: '1', msg: '分享成功'},
    {code: '2', msg: '微信客户端版本过低，请升级最新版本'},
    {code: '3', msg: '获取接口的签名失效，请重新调用方法获取API授权签名'},
    {code: '4', msg: '微信分享失败，请重新分享'},
    {code: '5', msg: '接口访问失败'},
    {code: '6', msg: 'jsApi配置成功'}
  ]
};

/**
 * 微信 api 全局管理器
 */
let instance;

class WeChat {
  constructor() {
    if (!instance) {
      instance = this;
    }
    this.hasInit = false;
    return instance;
  }

  init() {
    return new Promise(async (resolve, reject) => {
      if (this.hasInit) {
        resolve({msg: 'success'});
        return;
      }
      try {
        // const config = await axiosInstance.post(Url.SIGNATURE, {url: location.origin});
        const config = {};
        const registerData = {
          debug: false,
          appId: DEFAULT_DATA.appId,
          timestamp: config.timestamp,
          nonceStr: config.noncestr,
          signature: config.signature,
          jsApiList: DEFAULT_DATA.apiList
        };
        wx.config(registerData);
        wx.ready(() => {
          console.log('wx.ready');
          wx.hideAllNonBaseMenuItem && wx.hideAllNonBaseMenuItem();
          if (!localStorage.getItem('userUnionId')) {
            closeWindow();
            throw new Error('unionid is null');
          }
          this.hasInit = true;
          resolve({msg: 'success'});
        });
        wx.error(res => {
          wx.hideAllNonBaseMenuItem && wx.hideAllNonBaseMenuItem();
          // Vue.$toast('请退出去重新进入');
          // closeWindow();
          // throw res;
        });
      } catch (e) {
        throw e;
      }
    });
  }
}

function closeWindow() {
  typeof wx !== 'undefined' && wx.closeWindow && wx.closeWindow();
}

/**
 * 获取 code
 */
function getCode() {
  const url = encodeURIComponent(location.href);
  window.location.href = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${APP_ID}&redirect_uri=${url}&response_type=code&scope=snsapi_userinfo&connect_redirect=1&state=${Util.getRandomKey()}#wechat_redirect`;
}

/**
 * 获取 user unionId
 */
function getUnionId() {
    return new Promise(async (resolve, reject) => {
    const existedUnionId = localStorage.getItem('userUnionId');
    if (existedUnionId) {
        console.log('缓存中的 onion_id:', existedUnionId, ', 不发请求');
        http.actions.setLoading(store, {status: false});
        user.actions.setOpenId(store, existedUnionId);
        resolve({msg: 'success'});
        return;
    }
    const code = Util.getUrlSearchParameter().code;
    console.log('code:', code);
    if (code) {
        const result = await axiosInstance.get(Url.USER_INFO, {params: {code}}).catch(e => {
            closeWindow();
            throw e;
        });
        result.telephone && user.actions.setTelephoneNumber(store, result.telephone);
        result.openid && user.actions.setOpenId(store, result.openid);
        result.unionid && user.actions.setUnionId(store, result.unionid);
        result.nickname && user.actions.setNickname(store, result.nickname);
        result.headimgurl && user.actions.setHeadImgUrl(store, result.headimgurl);
        resolve({msg: 'success'});
    } else {
        console.log('没有 code，微信即将重定向···');
        getCode();
    }
  });
}

export {
  WeChat,
  getUnionId,
  closeWindow
};
```

wechat.js 里面涉及到的 Util 方法：
```js
/**
* 生成唯一的 key
*/
export function getRandomKey(len = 6) {
    len = Object.prototype.toString.call(len) === '[object Number]' ? len : 6;
    len = Math.abs(len) || 6;
    return Math.random().toString(16).substr(-len);
}

/**
* 获取 URL 的 search 参数值
*/
export function getUrlSearchParameter() {
    const search = window.location.search.replace('?', '');
    const searchList = search.split('&');
    const searchObj = {};
    searchList.length > 0 && searchList.forEach(v => {
      const list = v.split('=');
      if (list.length === 2) {
        searchObj[list[0]] = list[1];
      }
    });
    return searchObj;
}
```
