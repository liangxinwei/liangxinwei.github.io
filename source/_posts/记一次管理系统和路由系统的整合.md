---
title: 记一次管理系统和路由系统的整合
date: 2017-09-28 18:58:27
categories: 前端
---

## 需求：整合管理系统和路由系统

## UI：
同 [Ant Design Pro](https://preview.pro.ant.design/) 

## 分析
由于左侧管理菜单内容在运行时才能确定，而且点击菜单要和右侧内容区联动，地址栏也要有相应的改变，而目前已有的路由系统都是要运行之前要确定具体的路由组建，因此采用 h5 的 history 和 传统的 document.location 结合的方式实现路由系统；整个项目的数据管理则因为考虑到左侧菜单对应的组件可能会使用包括 redux/mbox/dva/kao 之类的框架，如果也使用框架的话，可能会引起冲突，故通过 react 的 context 来实现。

## 路由系统 router.js
```js
let instance = undefined;
class Router {
    constructor() {
        if (!instance) {
            this.history = window.history;
            this.location = window.location;
            instance = this;
        }
        return instance;
    }

    goBack = (cb) => {
        this.history.back();
        cb && cb();
    }

    goForward = (cb) => {
        this.history.forward();
        cb && cb();
    }

    go = (num, cb) => {
        this.history.go(num);
        cb && cb();
    }

    pushState = (url, state, cb) => {
        url = url || '';
        // 加 #，以 hash 的方式改变 url；如果不加，直接以 '/abc' 更改，刷新会报错，请求不到资源（js,css,···）
        url = url[0] === '/' ? `#${url}` : `/#${url}`;
        this.history.pushState(state || null, '', url);
        cb && cb();
    }

    replaceState = (url, state, cb) => {
        url = url || '/';
        url = url[0] === '/' ? `#${url}` : `/#${url}`;
        this.history.replaceState(state || null, '', url);
        cb && cb();
    }

    currentState = () => {
        return this.history.state;
    }

    currentUrl = () => {
        let url = this.location.hash.replace('#', '');
        if (url[0] === '/') {
            url = url.replace('/', '');
        }
        return url;
    }

    rootUrl = () => {
        return this.location.host;
    }

    originUrl = () => {
        return this.location.origin;
    }

    fullUrl = () => {
        return this.location.href;
    }

    historyLength = () => {
        return this.history.length;
    }
}

/**
 * 拦截器 拦截读写权限
 */
const handler = {
    set(target, key, value) {
        throw new Error(`Setting the ${key} prototype is forbidden`);
    },
    deleteProperty(target, key) {
        throw new Error(`Deleting the ${key} prototype is forbidden`);
    },
    defineProperty (target, key, descriptor) {
        throw new Error(`Defining the ${key} prototype is forbidden`);
    },
    setPrototypeOf (target, proto) {
        throw new Error('Changing the prototype is forbidden');
    }
};

const routerInstance = new Proxy(new Router(), handler);
```
## 路由装饰函数 withRouter.js
```js
const withRouter = (config = {}) => (WrapComponent) => {
    return class Component extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                data: {}
            };
        }

        componentDidMount() {
            config.listenPopState === true && window.addEventListener('popstate', this.handlePopState);
        }

        handlePopState = (data) => {
            this.setState({data: data});
        }

        componentWillUnmount() {
            config.listenPopState === true && window.removeEventListener('popstate', this.handlePopState);
        }

        render() {
            const router = {
                go: routerInstance.go,
                goBack: routerInstance.goBack,
                fullUrl: routerInstance.fullUrl,
                rootUrl: routerInstance.rootUrl,
                originUrl: routerInstance.originUrl,
                goForward: routerInstance.goForward,
                pushState: routerInstance.pushState,
                currentUrl: routerInstance.currentUrl,
                replaceState: routerInstance.replaceState,
                currentState: routerInstance.currentState,
                historyLength: routerInstance.historyLength
            };
            return React.createElement(WrapComponent, {
                routerData: this.state.data,
                router: new Proxy(router, handler),// handler 上面定义的拦截器
                ...this.props
            });
        }
    };
};
```
## 入口组建 App.js
```jsx
import React from 'react';
import PropTypes from 'prop-types';
import {Layout} from 'antd';

import GYSider from './GYSider';
import GYHeader from './GYHeader';
import GYContent from './GYContent';
import Test_1 from '../app/Test_1';
import Test_2 from '../app/Test_2';
import Test_3 from '../app/Test_3';
import Test_1_1_1 from '../app/Test_1_1_1';
import {withRouter} from '../util/router';
import Util from '../util/Util';

const {Header, Sider, Content} = Layout;

@withRouter()
class App extends React.Component {
    constructor(props) {
        super(props);
        const propsState = props.initialState || {};
        const initialState = {
            menuList: [
                {
                    path: 'test_1',
                    icon: 'user',
                    text: 'test_1',
                    component: Test_1,
                    children: [
                        {
                            path: 'test_1/test_1_1',
                            text: 'test_1_1',
                            children: [
                                {
                                    path: 'test_1/test_1_1/test_1_1_1',
                                    component: Test_1_1_1,
                                    text: 'test_1_1_1'
                                }
                            ]
                        }
                    ]
                },
                {
                    path: 'test_2',
                    icon: 'setting',
                    text: 'test_2',
                    component: Test_2
                },
                {
                    path: 'test_3',
                    icon: 'logout',
                    text: 'test_3',
                    component: Test_3
                }
            ]
        };
        this.state = {
            store: {
                menuList: initialState.menuList.concat(propsState.menuList || [])
            },
            collapsed: false,
            currentPath: '',
            currentComponent: GYContent
        };
        this.getAllComponent(this.state.store.menuList);
    }

    /**
     * 保存所有的路由对应的组件
     */
    getAllComponent = (menuList = []) => {
        this.allComponent = this.allComponent || new Map();
        menuList.forEach(val => {
            if (val.path && Util.isReactComponent(val.component)) {
                this.allComponent.set(val.path, val.component);
            }
            if (Util.isArray(val.children)) {
                this.getAllComponent(val.children);
            }
        });
    }

    static contextTypes = {
        store: PropTypes.object,
        onClickAction: PropTypes.func
    }

    static childContextTypes = {
        store: PropTypes.object.isRequired,
        onClickAction: PropTypes.func.isRequired
    }

    /**
     * 子组件获取 store
     */
    getChildContext() {
        return {
            store: this.state.store,
            onClickAction: this.handleClickAction
        };
    }

    /**
     * 更新 store 时需要返回合并之后的数据
     */
    handleClickAction = (data) => {
        this.setState(Object.assign(this.state, data));
    }

    componentWillMount() {
        // 刷新浏览器，跳转到相应页面
        const currentPath = this.state.currentPath;
        const documentHref = this.props.router.currentUrl();
        if (currentPath !== documentHref && this.allComponent.has(documentHref)) {
            this.setState({
                currentComponent: this.allComponent.get(documentHref)
            });
        }
    }

    onToggle = () => {
        this.setState({
            collapsed: !this.state.collapsed
        });
    }

    onCollapse = () => {
        console.log('onCollapse');
    }

    render() {
        const Component = this.state.currentComponent;
        return (
            <Layout className='gy-app-view'>
                <Sider
                    collapsible
                    breakpoint="md"
                    width={256}
                    collapsed={this.state.collapsed}
                    trigger={null}
                    onCollapse={this.onCollapse}
                >
                    <GYSider/>
                </Sider>
                <Layout>
                    <Header className='header'>
                        <GYHeader collapsed={this.state.collapsed} onToggle={this.onToggle}/>
                    </Header>
                    <Content className='gy-content'>
                        <Component/>
                    </Content>
                </Layout>
            </Layout>
        );
    }
}

export default App;
```
## 侧边栏组件
```jsx
import React, {Component} from 'react';
import {Menu, Icon} from 'antd';
const SubMenu = Menu.SubMenu;

import Util from '../util/Util';
import {withRouter} from '../util/router';
import connectStore from '../util/connectStore';

@withRouter()   // 接入路由
@connectStore   // 接入 store
class GYSider extends Component {
    constructor(props) {
        super(props);
    }

    componentWillReceiveProps(nextProps, nextContext) {
        console.log('点击 subMenu 更新 store', nextContext.store);
    }

    onMenuClick = ({item, key, keyPath}) => {
        let self = this;
        const path = item.props.path;
        const currentUrl = this.props.router.currentUrl() || '';
        path && path !== currentUrl && item.props.component
        && self.props.router.pushState(`/${path}`, {path: `/${path}`}, () => {
            self.context.onClickAction({
                currentPath: path,
                currentComponent: item.props.component
            });
        });
    }

    /**
     * 更新 store 示例
     */
    onSubMenuClick = ({key, domEvent}) => {
        let store = this.context.store;
        this.context.onClickAction({store: Object.assign(store, {[key]: key})});
    }

    createMenu = (arr = []) => {
        return arr.map && arr.map(val => {
                if (!val.text) {
                    return undefined;
                } else {
                    const key = val.path || Util.generateKey();
                    return Util.isArray(val.children) ?
                        <SubMenu
                            key={key}
                            onTitleClick={this.onSubMenuClick}
                            title={<span>{val.icon && <Icon type={`${val.icon}`}/>}
                                <span>
                                    {val.text}
                                </span>
                            </span>}>
                            {this.createMenu(val.children)}
                        </SubMenu>
                        :
                        <Menu.Item path={val.path} key={key} component={val.component}>
                            {val.icon && <Icon type={`${val.icon}`}/>}
                            <span>
                                {val.text}
                            </span>
                        </Menu.Item>;
                }
            }).filter(val => val !== undefined);
    }

    render() {
        return (
            <div>
                <div className='logo'></div>
                <Menu
                    theme="dark"
                    mode="inline"
                    onClick={this.onMenuClick}
                    style={{margin: '16px 0', width: '100%'}}
                >
                    {this.createMenu(this.context.store.menuList)}
                </Menu>
            </div>
        );
    }
}

export default GYSider;
```
## 接入 store 装饰函数 connectStore.js
```js
import PropTypes from 'prop-types';

export default function connectStore(Component) {
    if (!Component || typeof Component !== 'function') {
        console.error(`${Component && Component.name} is not a class`);
        return;
    }
    Component.contextTypes = {
        store: PropTypes.object,
        onClickAction: PropTypes.func
    };
}
```
## 使用示例
```jsx
import React, {Component} from 'react';
import 上面的入口组建 App
import UMD from './UMD';

class WrapView extends Component {
    constructor(props) {
        super(props);
    }

    render() {
        let initialState = {
            menuList: [
                {
                    path: 'umd',        //对应的地址栏 url
                    icon: 'setting',    //侧边栏的显示图标
                    text: 'umd',        //侧边栏的显示文字
                    component: UMD      //点击时对应的右侧内容区组件
                }
            ]
        };
        return (
            <App initialState={initialState}/>
        );
    }
}

export default WrapView;

···

import React from 'react';
import {render} from 'react-dom';
import WrapView from './app/components/WrapView';

/**
 * Main App View
 */
render(<WrapView />, document.getElementById('app'));
```
**核心思路**是通过 context 达到类似于 redux 管理数据的目的，App.js 提供 store（存储数据） 和 onClickAction（修改 store）给子组件，子组件通过 connectStore 装饰函数获取到 store 和 onClickAction，点击侧边栏的时候，先取到设置的 path 和 component，然后通过 onCLickAction 设置 currentComponent 和 currentPath，然后 setState 即可实现需求。
目前还有一个问题，就是刷新浏览器的时候如何跳转到相应的页面呢？
可以在 App.js 里面先获取到所有的 component 和 path 然后保存起来：
```js
/**
* 保存所有的路由对应的组件
*/
getAllComponent = (menuList = []) => {
    this.allComponent = this.allComponent || new Map();
    menuList.forEach(val => {
        if (val.path && Util.isReactComponent(val.component)) {
            this.allComponent.set(val.path, val.component);
        }
        if (Util.isArray(val.children)) {
            this.getAllComponent(val.children);
        }
    });
}
```
再在 App.js 通过以下代码跳转：
```js
componentWillMount() {
    // 刷新浏览器，跳转到相应页面
    const currentPath = this.state.currentPath;
    const documentHref = this.props.router.currentUrl();
    if (currentPath !== documentHref && this.allComponent.has(documentHref)) {
        this.setState({
            currentComponent: this.allComponent.get(documentHref)
        });
    }
}
```
